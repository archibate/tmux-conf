# Tmux Config - Vim User Edition

# -- Basic Quality of Life --
set -g mouse on
set -s escape-time 0
set -s set-clipboard on
set -gq allow-passthrough on
set -g visual-activity off

# -- True Color Support --
if-shell 'test -n "$KITTY_PID"' \
    'set -g default-terminal "xterm-kitty"' \
    'set -g default-terminal "xterm-256color"'
set-option -ga terminal-overrides ",xterm-kitty:Tc"
set -as terminal-features '*:sixel'

# --- Prefix Setup ---
unbind C-b
set -g prefix C-z
set -g prefix2 C-s
bind C-z send-prefix

# --- Vim-like Pane Navigation ---
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# --- Vim-like Pane Resizing ---
# bind H resize-pane -L 5
# bind J resize-pane -D 5
# bind K resize-pane -U 5
# bind L resize-pane -R 5
bind z resize-pane -Z

# --- Vim-like Pane Moving ---
bind H "select-pane -m; select-pane -L; swap-pane; select-pane -L; select-pane -M"
bind J "select-pane -m; select-pane -D; swap-pane; select-pane -D; select-pane -M"
bind K "select-pane -m; select-pane -U; swap-pane; select-pane -U; select-pane -M"
bind L "select-pane -m; select-pane -R; swap-pane; select-pane -R; select-pane -M"

# --- Vim-like Splits (like :split and :vsplit) ---
bind s split-window -v -c "#{pane_current_path}"  # horizontal split (like :split)
bind v split-window -h -c "#{pane_current_path}"  # vertical split (like :vsplit)
# bind r rotate-window

# # --- Vim-like Window Motion Shortcut ---
# is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?\.?(view|n?vim?x?)(-wrapped)?(diff)?$'"
#
# bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' { if -F '#{pane_at_left}' '' 'select-pane -L' }
# bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
# bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' { if -F '#{pane_at_top}' '' 'select-pane -U' }
# bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' { if -F '#{pane_at_right}' '' 'select-pane -R' }
# bind-key -n 'C-n' if-shell "$is_vim" 'send-keys C-n' { if -F '#{window_end_flag}' '' 'select-window -n' }
# bind-key -n 'C-p' if-shell "$is_vim" 'send-keys C-p' { if 'test #{window_index} -gt #{base-index}' 'select-window -p' }
#
# bind-key -T copy-mode-vi 'C-h' if -F '#{pane_at_left}' '' 'select-pane -L'
# bind-key -T copy-mode-vi 'C-j' if -F '#{pane_at_bottom}' '' 'select-pane -D'
# bind-key -T copy-mode-vi 'C-k' if -F '#{pane_at_top}' '' 'select-pane -U'
# bind-key -T copy-mode-vi 'C-l' if -F '#{pane_at_right}' '' 'select-pane -R'
# bind-key -T copy-mode-vi 'C-n' if -F '#{window_end_flag}' '' 'select-window -n'
# bind-key -T copy-mode-vi 'C-p' if 'test #{window_index} -gt #{base-index}' 'select-window -p'

# --- Vim-like Window Management (tabs) ---
bind c new-window -c "#{pane_current_path}"
bind t new-window -c "#{pane_current_path}"
bind \; last-pane
bind a last-window
bind A switch-client -l  # Last session
bind n next-window
bind p previous-window
# bind -r C-n next-window
# bind -r C-p previous-window
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9
bind 0 select-window -t 10
bind , command-prompt -I "#W" "rename-window '%%'"
# bind -r C-h move-window -t -
# bind -r C-l move-window -t +
bind -r C-n swap-window -t +1\; select-window -t +1
bind -r C-p swap-window -t -1\; select-window -t -1
# Window picker - shows windows in current session with preview
bind w display-popup -w 70% -h 70% -E '~/.config/tmux/scripts/tmux_window_picker.sh'
# Session picker - shows sessions with preview (Ctrl-N to create new)
bind f display-popup -w 70% -h 70% -E '~/.config/tmux/scripts/tmux_session_picker.sh'
# Tmux catalog picker - shows all sessions/windows with descriptions
bind F display-popup -w 90% -h 90% -E '~/.config/tmux/scripts/tmux_catalog.sh'
# Brief popup - show attention report (ðŸ”´ðŸŸ¡ issues)
# bind B display-popup -w 80% -h 60% -E '~/.config/tmux/scripts/tmux_brief_popup.sh'
bind X kill-window
bind x kill-pane

# --- Pane Movement ---
bind b break-pane  # Move pane to new window (like ! to break out)
bind m command-prompt -p "join pane to window:" "join-pane -t ':%%'"  # Move to specific window

# --- Renaming ---
bind . command-prompt -I "#S" "rename-session '%%'"  # Rename session (like vim :file)

# --- Clipboard / Copy Mode ---
bind P paste-buffer
# Enter copy mode with prefix + Esc (like entering Normal mode in vim)
bind Escape copy-mode
bind Enter copy-mode

# Exit copy mode with i or a (like entering Insert mode in vim)
bind -T copy-mode-vi i send -X cancel
bind -T copy-mode-vi a send -X cancel
bind -T copy-mode-vi q send -X cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi Enter send -X cancel

# Enable vi mode
set-window-option -g mode-keys vi

# Helper to clean state file
# CLEAN_STATE="SESSION_ID=\$(tmux display-message -p '#{session_id}'); WINDOW_ID=\$(tmux display-message -p '#{window_id}'); PANE_ID=\$(tmux display-message -p '#{pane_id}'); rm -f /tmp/tmux_visual_state/visual_\${SESSION_ID}_\${WINDOW_ID}_\${PANE_ID}"
#
# # Press 'v' to toggle visual mode on/off
# unbind-key -T copy-mode-vi v
# bind-key -T copy-mode-vi v run-shell 'bash ~/.config/tmux/toggle-visual.sh'
#
# # Clean state when exiting copy mode entirely
# bind-key -T copy-mode-vi q run-shell "$CLEAN_STATE" \; send-keys -X cancel
# bind-key -T copy-mode-vi Escape run-shell "$CLEAN_STATE" \; send-keys -X cancel
#
# # Clean state when copying selection
# bind-key -T copy-mode-vi y run-shell "$CLEAN_STATE" \; send-keys -X copy-selection-and-cancel

# Vim-like visual selection
unbind-key -T copy-mode-vi v
bind -T copy-mode-vi d send -X clear-selection
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle

# Vim-like clipboard paste
unbind -T copy-mode-vi p
bind -T copy-mode-vi p paste-buffer \; send -X cancel

# bind Y run-shell 'tmux save-buffer - | xclip -selection clipboard 2>/dev/null || tmux display "xclip not installed"'

# Quick save pane to file
bind C-w run-shell 'tmux capture-pane -p -S - -E - > /tmp/tmux-capture-$(date +"%Y%m%d-%H%M%S").txt' \; display 'Pane saved to /tmp/tmux-capture-YYYYMMDD-HHMMSS.txt'

# Stats popup - show detailed LOAD/CPU/MEM/GLM with 20-point sparklines
bind i display-popup -w 50 -h 13 -E '~/.config/tmux/scripts/stats_popup.sh'

# --- Quick Help ---
bind ? list-keys -T prefix

# --- Settings ---
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 10000
set -g status-interval 5

setw -g automatic-rename on
set -g set-titles on
set -g display-panes-time 1000
set -g display-time 1000

# --- Status Bar ---
set -g status on                    # Enable status bar
set -g status-justify centre        # Center window list
set -g status-left-length 40
set -g status-right-length 80
set -g status-left "#[bg=#83a598,fg=#1d2021,bold] #S "
# set -g status-right "#(~/.config/tmux/scripts/sparkline_stats.sh 1) #(~/.config/tmux/scripts/tmux_brief_indicator.sh) #[bg=#32302f,fg=#a89984] %H:%M #[bg=#1d2021]#{tmux_mode_indicator}"
set -g status-right "#(~/.config/tmux/scripts/sparkline_stats.sh 1) #[bg=#32302f,fg=#a89984] %H:%M #[bg=#1d2021]#{tmux_mode_indicator}"

setw -g pane-border-status top
setw -g pane-border-format '#{?#{==:thinking,#{@claude-status}},#[fg=#fe8019],}#{pane_index} #{pane_current_command}#{?#{==:thinking,#{@claude-status}}, âœ»,} #{b:pane_current_path}'
set -g pane-border-style 'fg=#3c3836'
set -g pane-active-border-style 'fg=#83a598'
set -g status-style 'bg=#1d2021,fg=#ebdbb2'
set -g message-style 'bg=#d79921,fg=#1d2021'
set -g message-command-style 'bg=#83a598,fg=#1d2021'
set -g mode-style 'bg=#fe8019,fg=#1d2021'

setw -g window-status-separator ' '
# Window number shows orange when Claude is thinking, otherwise normal gray
setw -g window-status-format '#[bg=#1d2021,fg=#504945]#{window_index} #[fg=#928374]#W'
setw -g window-status-current-format '#[bg=#3c3836,fg=#928374,bold]#{window_index} #[fg=#83a598]#W'
setw -g window-status-activity-style 'fg=#fe8019,bg=#1d2021'
setw -g window-status-bell-style 'fg=#d3869b,bg=#1d2021'

# --- Claude Code Status Indicator ---
# Shows âœ» in window list when Claude is thinking (uses window option, doesn't rename windows)
# Status monitor runs continuously in background, checking every 1 second
# DISABLED: capture-pane causes cursor flicker in TUI apps
# run-shell -b '~/.config/tmux/scripts/claude_status.sh --monitor'
# Start brief monitor - checks for issues every 2 minutes
# run-shell -b '~/.config/tmux/scripts/tmux_brief_monitor.sh'  # DISABLED

# --- Plugins ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
# set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-sidebar'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'MunifTanjim/tmux-mode-indicator'
set -g @plugin 'aserowy/tmux.nvim'

# navigation
set -g @tmux-nvim-navigation true
set -g @tmux-nvim-navigation-cycle true
set -g @tmux-nvim-navigation-keybinding-left 'C-h'
set -g @tmux-nvim-navigation-keybinding-down 'C-j'
set -g @tmux-nvim-navigation-keybinding-up 'C-k'
set -g @tmux-nvim-navigation-keybinding-right 'C-l'

# resize
set -g @tmux-nvim-resize true
set -g @tmux-nvim-resize-step-x 1
set -g @tmux-nvim-resize-step-y 1
set -g @tmux-nvim-resize-keybinding-left 'M-h'
set -g @tmux-nvim-resize-keybinding-down 'M-j'
set -g @tmux-nvim-resize-keybinding-up 'M-k'
set -g @tmux-nvim-resize-keybinding-right 'M-l'

run '~/.tmux/plugins/tpm/tpm'

# --- tmux-resurrect settings ---
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'

# --- tmux-continuum settings ---
set -g @continuum-restore 'on'  # Auto-restore on tmux start
set -g @continuum-save-interval '15'  # Auto-save every 15 minutes

# --- tmux-yank settings ---
# Use OSC 52 for remote clipboard support
set -g @yank_action 'copy-pipe'
set -g @yank_with_mouse on

# --- tmux-mode-indicator settings ---
set -g @mode_indicator_prefix_prompt ' WAIT '
set -g @mode_indicator_copy_prompt ' COPY '
set -g @mode_indicator_sync_prompt ' SYNC '
set -g @mode_indicator_empty_prompt ' TMUX '
set -g @mode_indicator_prefix_mode_style 'bg=green,fg=black'
set -g @mode_indicator_copy_mode_style 'bg=orange,fg=black'
set -g @mode_indicator_sync_mode_style 'bg=red,fg=black'
set -g @mode_indicator_empty_mode_style 'bg=cyan,fg=black'

# Initialize TPM (keep this at the bottom)
run '~/.tmux/plugins/tpm/tpm'
