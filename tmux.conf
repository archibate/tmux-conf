# Tmux Config - Vim User Edition

# -- Basic Quality of Life --
set -g mouse on
set -s escape-time 0
set -s set-clipboard on

# -- True Color Support --
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm*:Tc:Cs=\\E]12%p1%s\\a:Cr=\\E]112\\a"

# --- Prefix Setup ---
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# --- Vim-like Pane Navigation ---
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# --- Vim-like Pane Resizing ---
bind H resize-pane -L 5
bind J resize-pane -D 5
bind K resize-pane -U 5
bind L resize-pane -R 5

# --- Vim-like Splits (like :split and :vsplit) ---
bind s split-window -v -c "#{pane_current_path}"  # horizontal split (like :split)
bind v split-window -h -c "#{pane_current_path}"  # vertical split (like :vsplit)
bind r rotate-window

# --- Vim-like Window Management (tabs) ---
bind c new-window -c "#{pane_current_path}"
bind t new-window -c "#{pane_current_path}"
bind a last-window
bind A switch-client -l  # Last session
bind n next-window
bind p previous-window
bind -r C-n next-window
bind -r C-p previous-window
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9
bind , command-prompt -I "#W" "rename-window '%%'"
bind -r C-h move-window -t -
bind -r C-l move-window -t +
# Window picker - shows windows in current session with preview
bind w display-popup -w 70% -h 70% -E '~/.config/tmux/scripts/tmux_window_picker.sh'
# Session picker - shows sessions with preview (Ctrl-N to create new)
bind f display-popup -w 70% -h 70% -E '~/.config/tmux/scripts/tmux_session_picker.sh'
# Tmux catalog picker - shows all sessions/windows with descriptions
bind F display-popup -w 90% -h 90% -E '~/.config/tmux/scripts/tmux_catalog.sh'
# Brief popup - show attention report (ðŸ”´ðŸŸ¡ issues)
bind B display-popup -w 80% -h 60% -E '~/.config/tmux/scripts/tmux_brief_popup.sh'
bind X kill-window
bind x kill-pane

# --- Pane Movement ---
bind b break-pane  # Move pane to new window (like ! to break out)
bind m command-prompt -p "join pane to window:" "join-pane -t '%%'"  # Move to specific window

# --- Renaming ---
bind . command-prompt -I "#S" "rename-session '%%'"  # Rename session (like vim :file)

# --- Clipboard / Copy Mode ---
bind P paste-buffer
# Enter copy mode with Ctrl-Space Esc (like entering Normal mode in vim)
bind Escape copy-mode

# Exit copy mode with i or a (like entering Insert mode in vim)
bind -T copy-mode-vi i send -X cancel
bind -T copy-mode-vi a send -X cancel
bind -T copy-mode-vi q send -X cancel
bind -T copy-mode-vi Escape send -X cancel

# Enable vi mode
set-window-option -g mode-keys vi

# Helper to clean state file
# CLEAN_STATE="SESSION_ID=\$(tmux display-message -p '#{session_id}'); WINDOW_ID=\$(tmux display-message -p '#{window_id}'); PANE_ID=\$(tmux display-message -p '#{pane_id}'); rm -f /tmp/tmux_visual_state/visual_\${SESSION_ID}_\${WINDOW_ID}_\${PANE_ID}"
#
# # Press 'v' to toggle visual mode on/off
# unbind-key -T copy-mode-vi v
# bind-key -T copy-mode-vi v run-shell 'bash ~/.config/tmux/toggle-visual.sh'
#
# # Clean state when exiting copy mode entirely
# bind-key -T copy-mode-vi q run-shell "$CLEAN_STATE" \; send-keys -X cancel
# bind-key -T copy-mode-vi Escape run-shell "$CLEAN_STATE" \; send-keys -X cancel
#
# # Clean state when copying selection
# bind-key -T copy-mode-vi y run-shell "$CLEAN_STATE" \; send-keys -X copy-selection-and-cancel

# Vim-like visual selection
unbind-key -T copy-mode-vi v
bind -T copy-mode-vi d send -X clear-selection
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle

# Vim-like clipboard paste
unbind -T copy-mode-vi p
bind -T copy-mode-vi p paste-buffer \; send -X cancel

bind Y run-shell 'tmux save-buffer - | xclip -selection clipboard 2>/dev/null || tmux display "xclip not installed"'

# Quick save pane to file
bind C-w run-shell 'tmux capture-pane -p -S - -E - > ~/tmux-capture-$(date +"%Y%m%d-%H%M%S").txt' \; display 'Pane saved to ~/tmux-capture-*.txt'

# Stats popup - show detailed LOAD/CPU/MEM/GLM with 20-point sparklines
bind i display-popup -w 50 -h 13 -E '~/.config/tmux/scripts/stats_popup.sh'

# --- Quick Help ---
bind ? list-keys -T prefix

# --- Settings ---
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 10000
set -g status-interval 5

setw -g automatic-rename on
set -g set-titles on
set -g display-panes-time 1000
set -g display-time 1000

# --- Status Bar ---
set -g status on                    # Enable status bar
set -g status-justify centre        # Center window list
set -g status-left-length 40
set -g status-right-length 80
set -g status-left "#[bg=#83a598,fg=#1d2021,bold] #S "
# set -g status-right "#(~/.config/tmux/scripts/sparkline_stats.sh 1) #(~/.config/tmux/scripts/tmux_brief_indicator.sh) #[bg=#32302f,fg=#a89984] %H:%M #[bg=#1d2021]#{tmux_mode_indicator}"
set -g status-right "#(~/.config/tmux/scripts/sparkline_stats.sh 1) #[bg=#32302f,fg=#a89984] %H:%M #[bg=#1d2021]"

setw -g pane-border-status top
setw -g pane-border-format '#{?#{==:thinking,#{@claude-status}},#[fg=#fe8019],}#{pane_index} #{pane_current_command}#{?#{==:thinking,#{@claude-status}}, âœ»,} #{b:pane_current_path}'
set -g pane-border-style 'fg=#3c3836'
set -g pane-active-border-style 'fg=#83a598'
set -g status-style 'bg=#1d2021,fg=#ebdbb2'
set -g message-style 'bg=#d79921,fg=#1d2021'
set -g message-command-style 'bg=#83a598,fg=#1d2021'
set -g mode-style 'bg=#fe8019,fg=#1d2021'

setw -g window-status-separator ' '
# Window number shows orange when Claude is thinking, otherwise normal gray
setw -g window-status-format '#[bg=#1d2021,fg=#504945]#{window_index} #[fg=#928374]#W'
setw -g window-status-current-format '#[bg=#3c3836,fg=#928374,bold]#{window_index} #[fg=#83a598]#W'
setw -g window-status-activity-style 'fg=#fe8019,bg=#1d2021'
setw -g window-status-bell-style 'fg=#d3869b,bg=#1d2021'

# --- Claude Code Status Indicator ---
# Shows âœ» in window list when Claude is thinking (uses window option, doesn't rename windows)
# Status monitor runs continuously in background, checking every 1 second
# DISABLED: capture-pane causes cursor flicker in TUI apps
# run-shell -b '~/.config/tmux/scripts/claude_status.sh --monitor'
# Start brief monitor - checks for issues every 2 minutes
# run-shell -b '~/.config/tmux/scripts/tmux_brief_monitor.sh'  # DISABLED

# --- Plugins ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-sidebar'
set -g @plugin 'alexwforsythe/tmux-which-key'
set -g @plugin 'MunifTanjim/tmux-mode-indicator'

# --- tmux-resurrect settings ---
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-vim 'session'
set -g @resurrect-strategy-nvim 'session'

# --- tmux-continuum settings ---
set -g @continuum-restore 'on'  # Auto-restore on tmux start
set -g @continuum-save-interval '15'  # Auto-save every 15 minutes

# --- tmux-yank settings ---
# Use OSC 52 for remote clipboard support
set -g @yank_action 'copy-pipe'
set -g @yank_with_mouse on

# --- tmux-mode-indicator settings ---
set -g @mode_indicator_prefix_prompt ' WAIT '
set -g @mode_indicator_copy_prompt ' COPY '
set -g @mode_indicator_sync_prompt ' SYNC '
set -g @mode_indicator_empty_prompt ' TMUX '
set -g @mode_indicator_prefix_mode_style 'bg=green,fg=black'
set -g @mode_indicator_copy_mode_style 'bg=orange,fg=black'
set -g @mode_indicator_sync_mode_style 'bg=red,fg=black'
set -g @mode_indicator_empty_mode_style 'bg=cyan,fg=black'

# Initialize TPM (keep this at the bottom)
run '~/.tmux/plugins/tpm/tpm'
